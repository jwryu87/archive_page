---
title:  "SQL 파싱 부하"
toc: true
toc_sticky: true

categories:
  - SQL전문가가이드
---

----------

### 1. SQL 처리과정

 - 옵티마이저에 의해 생성된 처리절차를 실행계획이라고 부른다.
  - SQL 수행 시 옵티마이저가 실행계획을 만들어서 수행하는데 제일먼저 SQL 파싱을 한다.

#### 가. SQL 파싱(Parsing)

 - 오라클에서 SQL과 실행계획인 캐싱되는 영역은 라이브러리 캐시이다. 
 - 사용자 SQL 
 > - SQL 문장에 문법적 오류가 없는지 검사(Syntax 검사)
 > - 문법적으로 오류가 없다면 의미상 오류가 없는지 검사(Semantic 검사)
 > - SQL과 실행계획이 라이브러리 캐시에 캐싱되었는지 확인( 있다면 무거운 최적화 과정 하지 않음 ) (소프토 파싱 vs 하드 파싱)

#### 나. SQL 최적화(Optimization)

 - SQL 최적화를 담당하는 엔진이 옵티마이저다. 
 - 사용자가 요청한 SQL을 가장 빠르고 효율적으로 수행할 최적(최저비용)의 처리경로를 선택해 주는 DBMS의 핵심엔진이다.

----------


### 2. 캐싱된 SQL 공유

#### 가. 실행계획 공유 조건

 1. 문법적 오류와 의미상 오류가 없는지 검사한다. 
 2. 해시 함수로부터 반환된 해시 값으로 라이브러리 캐시 내 해시버킷을 찾아간다. 
 3. 찾아간 해시버킷에 체인으로 연결된 엔트리를 차례로 스캔하면서 같은 SQL 문장을 찾는다.
 4. SQL 문장을 찾으면 함께 저장된 실행계획을 가지고 바로 실행한다.
 5. 찾아간 해시버킷에서 SQL 문장을 찾지 못하면 최적화를 수행한다.
 6. 최적화를 거친 SQL과 실행계획을 방금 탐색한 해시버킷 체인에 연결한다.
 7. 방금 최적화한 실행계획을 가지고 실행한다.
   
  - 해시 값을 찾을때 사용되는 키값이 'SQL 문장 그 자체' 이다.

> - SQL 문장 중간에 작은 공백문자 하나만 추가되더라도 DBMS는 서로 다른 SQL 문장으로 인식해서 캐싱을 사용하지 않는다.

#### 나. 실행계획을 공유하지 못하는 경우

 1. 공백 문자 또는 줄바꿈
 2. 대소문자 구분
 3. 주석
 4. 테이블 Owner 표시
 5. 옵티마이져 힌트 사용
 6. 조건절 비교

> - 1~4번은 라이브러리 캐시 효율이 우려할 만큼 나빠지지 않는다.
> - 결론적으로 라이브러리 캐시 효율에 직접적으로 영향이 있는 것은 6번뿐이다.   
    (사용자가 입력한 값을 조건절에 문자열로 붙여가며 매번 다른 SQL로 실행되는 경우)

### 3. 바인드 변수 사용하기

#### 가. 바인드 변수의 중요성

 - 바인드변수: 파라미터 Driven 방식으로 SQL을 작성하는 방법
 - 바인드 변수를 사용하면 하나의 프로시저를 공유하면서 반복 재사용할 수 있게 된다.
 - 목적: 하드파싱에 의한 라이브러리 캐시 부하를 최소화하기 위해 사용
 - 바인드 변수를 사용하면 이를 처음 수행한 세션이 하드파싱을 통해 실행계획을 생성하고 이것을 라이브러리에 캐싱해 둠으로써 반복사용한다.
 - 아래의 경우 바인드 변수를 쓰지 않아도 된다.

> - DW, OLAP 등 정보계 시스템에서 사용되는 long Running 쿼리
> - 파싱시간 비중이 높아 라이브러리 캐시 부하를 유발할 가능성이 낮음
> - 옵티마이저가 칼럼 히스토그램을 활용할 수 있도록 하는 것이 유리
> - 조건절 칼럼의 값 종류(Distinct Value) 가 소수일 때
> - 특히 값 분포가 균일하지 않아 옵티마이저가 칼럼 히스토그램 정보를 활용하도록 유도하고자 할 때
> - 위의 경우가 아니라면, 특히 OLTP 환경에선 반드시 바인드 변수를 사용할 것을 권고한다.

#### 나. 바인드 변수 사용 시 주의 사항

 - 최적화 시 옵티마이저는 조건절 칼럼의 데이터 분포가 균일하다는 가정을 세우고 최적화를 수행한다.
 - 칼럼에 대한 히스토그램 정보가 딕셔너리에 저장돼 있어도 이를 활용하지 못한다.

#### 다. 바인드 변수 부작용을 극복하기 위한 노력

- 오라클: 바인드 변수 Peeking
- SQL 서버: Parameter Sniffing
- SQL이 첫번째 수행될 때의 바인드 변수 값을 살짝 훔쳐보고, 그 값에 대한 칼럼 분포를 이용해 실행계획을 결정하는 것


----------
