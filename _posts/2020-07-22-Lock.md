---
title:  "Lock"
toc: true
toc_sticky: true
---

----------


- lock 발생 시 DBA가 할 수 있는 일은 소유한 세션을 찾아서 프로세스를 강제 종료시키는 일 뿐이다.

### 1. Lock 기본

#### 가. Lock이란?

- 비싼돈주고 DBMS를 사용하는 가장큰 이유는 트랜잭션 때문이다.
- 각 DBMS별 Lock 메커니즘을 정확히 이해하고 있어야 한다. 

#### 나. 공유 Lock과 배타적 Lock

##### 1) 공유 Lock

- 데이터를 읽고자 할 때 사용된다.
- 공유 Lock을 설정한 리소스에 다른 트랜잭션이 추가로 공유 Lock을 설정할 수 있지만 배타적 Lock은 불가능하다.
- 자신이 읽고 있는 리소스를 다른 사용자가 동시에 읽을 수는 있어도 변경은 불가능하다.  = 다른 사용자가 읽고 있는 리소스를 동시에 읽을 수는 있어도 변경 중인 리소스를 동시에 읽을 수는 없다. 

##### 2) 배타적 Lock

- 데이터를 변경하고자 할 때 사용된다. 트랜잭션이 완료될 때까지 유지된다.

#### 다. 블로킹과 교착상태

##### 1) 블로킹

- Lock 경합이 발생해 특정 세션이 작업을 진행하지 못하고 멈춰선 상태를 말한다.
- 공유 Lock - 배타적 Lock / 배타적 Lock - 배타적 Lock
- 블로킹 상태를 해소하는 방법은 커밋(또는 롤백) 뿐이다.

Lock에 의한 성능 저하를 최소화하는 방안
```
(1) 트랜잭션의 원자성을 훼손하지 않는 선에서 트랜잭션을 가능한 짧게 정의하려는 노력이 필요하다. 

- 오라클에서는 공유 Lock을 사용하지 않기 때문에 다른 DBMS에 비해 상대적으로 Lock 경합이 적게 발생하긴 한다.

(2) 같은 데이터를 갱신하는 트랜잭션이 동시에 수행되지 않도록 설계하는 것도 중요 

- 특히 트랜잭션이 활발한 주간에 대용량 갱신 작업을 수행해선 안된다.

(3) 주간에 대용량 갱신 작업이 불가피하다면 블로킹 현상에 의해 사용자가 무한정 기다리지 않도록 적절한 프로그래밍 기법을 도입해야 한다. 

- SQL 서버: Lock_timeout 설정
- 오라클: nowait, wait 또는 exception 설정

(4) 트랜잭션 격리성 수준을 불필요하게 상향 조정하지 않는다.

(5) 트랜잭션을 잘 설계하고 대기 현상을 피하는 프로그래밍 기법을 적용하기에 앞서, SQL 문장이 가장 빠른 시간 내에 처리를 완료하도록 하는 것이 Lock 튜닝의 기본이고 효과도 가장 확실하다.
```

##### 2) 교착상태

- 두 세션이 각각 Lock을 설정한 리소스를 서로 액세스하려고 마주보며 진행하는 상황이다.
- 둘 중 하나가 뒤로 물러나지 않으면 영영 풀린 수 없다. 


----------


### 2. SQL Server Lock

#### 가. Lock 종류

##### 1) 공유 Lock

- SQL 서버의 공유 Lock은 트랜잭션이나 쿼리 수행이 완료될 때까지 유지되는 것이 아니라 다음 레코드가 읽히면 곧바로 해제된다. (기본 트랜잭션 격리성 수준에서만)

##### 2) 배타적 Lock

- 위 내용과 동일

##### 3) 갱신 Lock

##### 4) 의도 Lock

- 특정 로우에 Lock을 설정하면 그와 동시에 상위 레벨 개체에 내부적으로 의도 Lock이 설정된다.
- Lock을 설정하려는 개체의 하위 레벨에서 선행 트랜잭션이 어떤 작업을 수행 중인지를 알리는 용도로 사용되며 일종의 푯말(Flag)라고 할 수 있다.

##### 5) 스키마 Lock

##### 6) Bulk Update Lock

- 테이블에 데이터를 Bulk Copy 할 때 발생한다.

 

#### 나. Lock 레벨과 Escalation

```
 Lock Escalation

- 관리할 Lock 리소스가 정해진 임계치를 넘으면서 로우 레벨 락이 페이지, 익스텐트, 테이블 레벨 락으로 점점 확대되는 것을 말한다.

```

#### 다. Lock 호환성

- 한 리소스에 두 개 이상의 Lock을 동시에 설정할 수 있음을 뜻한다.


----------


### 3. Oracle Lock

- 오라클의 락은 사용자 데이터를 보호할 목적으로 Lock을 사용한다.
- 애플리케이션 개발 측면에서 가장 중요하게 다루어야 할 Lock은 무엇보다 DML Lock이다. 
- DML Lock은 다중 사용자에 의해 동시에 액세스되는 사용자 데이터의 무결성을 보호해 준다. 로우 Lock과 테이블 Lock이 있다.

#### 가. 로우 Lock

- 오라클에서 로우 Lock은 항상 배타적이다. (이 트랜잭션이 커밋 또는 롤뱁할 때까지 다른 트랜잭션은 해당 로우를 변경할 수 없다.)
- 오라클에서 일반 select 문에 의해 읽힌 레코드에는 어떤 Lock도 설정되지 않는다. 다른 DBMS처럼 읽기 작업에 대한 공유 Lock을 사용하지 않기 때문에 


----------

